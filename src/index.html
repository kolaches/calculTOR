<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Gravity Defied ‚Äî –ú–∞—à–∏–Ω–∫–∞</title>
    <style>
        :root{
          --ui-bg: rgba(20,22,30,.7);
          --ui-br: 12px;
          --ui-accent: #61dafb;
          --safe: env(safe-area-inset);
        }
        *{box-sizing:border-box}
        html,body{height:100%;}
        body{
          margin:0; overflow:hidden; background:#0e1116; color:#e5e7eb;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
        }
        canvas{display:block; width:100vw; height:100vh;}

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ (—Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É) */
        .controls{
          position:fixed; top:12px; right:12px; z-index:10;
          display:flex; gap:8px; align-items:center; flex-wrap:wrap;
          background:var(--ui-bg); border:1px solid rgba(255,255,255,.08);
          padding:10px; border-radius:var(--ui-br); backdrop-filter: blur(8px);
          box-shadow: 0 10px 30px rgba(0,0,0,.25);
        }
        .btn{ cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;
          border:1px solid rgba(255,255,255,.12);
          border-radius:10px; padding:8px 10px; min-width:42px; text-align:center; font-weight:600; font-size:14px;
          background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
          box-shadow:inset 0 1px 0 rgba(255,255,255,.2), 0 4px 18px rgba(0,0,0,.25);
          transition:transform .06s ease, background .2s ease, border-color .2s ease;
        }
        .btn:active{ transform: translateY(1px) scale(0.98); }
        .btn.on{ background:linear-gradient(180deg, rgba(97,218,251,.5), rgba(97,218,251,.15)); border-color: rgba(97,218,251,.6); }

        .meter{ padding:8px 10px; border-radius:10px; background:rgba(0,0,0,.2); font:600 12px/1.1 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#cbd5e1; }

        .help{ position:fixed; left:12px; top:12px; z-index:10; padding:10px 12px; border-radius:var(--ui-br); background:var(--ui-bg); border:1px solid rgba(255,255,255,.08); color:#cbd5e1; font-size:12px; line-height:1.4; }
        .help kbd{ background:#111827; color:#e5e7eb; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.12);}

        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–±–æ–ª—å—à–∏–µ –∫–Ω–æ–ø–∫–∏) */
        .mobile-pad{ position:fixed; inset:auto 0 18px 0; z-index:11; display:none; justify-content:space-between; align-items:flex-end; padding:0 14px; pointer-events:none; }
        .mobile-group{ display:flex; gap:12px; pointer-events:auto; }
        .big{ min-width:70px; min-height:70px; border-radius:999px; font-size:16px; }

        /* –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–∞—É–∑—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ */
        .pause-btn{ position:fixed; top:12px; left:50%; transform:translateX(-50%); z-index:12; display:none; }

        @media (pointer:coarse){
          /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: –ø–∞–Ω–µ–ª—å —É—Ö–æ–¥–∏—Ç –≤–Ω–∏–∑ –ø–æ —Ü–µ–Ω—Ç—Ä—É, –ø–ª—é—Å –±–æ–ª—å—à–∏–µ –ø—ç–¥-–∫–Ω–æ–ø–∫–∏ */
          .controls{ top:auto; bottom:calc(90px + 20px + var(--safe)); right:50%; transform:translateX(50%); }
          .mobile-pad{ display:flex; }
          .pause-btn{ display:block; }
        }
    </style>
</head>
<body>
<canvas id="game"></canvas>

<div class="controls" id="controls">
    <button class="btn" data-act="tiltL" title="–ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ (‚Üê)">‚ü≤</button>
    <button class="btn" data-act="tiltR" title="–ù–∞–∫–ª–æ–Ω –≤–ø—Ä–∞–≤–æ (‚Üí)">‚ü≥</button>
    <button class="btn" data-act="gas"   title="–ì–∞–∑ (‚Üë)">üöÄ –ì–∞–∑</button>
    <button class="btn" data-act="brake" title="–¢–æ—Ä–º–æ–∑ (‚Üì)">üß±</button>
    <button class="btn" data-act="reset" title="–°–±—Ä–æ—Å (R)">‚Ü∫</button>
    <button class="btn" data-act="pause" title="–ü–∞—É–∑–∞ (P)">‚è∏</button>
    <div class="meter" id="meter">—Å–∫–æ—Ä–æ—Å—Ç—å: 0</div>
</div>

<div class="help">
    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: <kbd>‚Üë</kbd> –≥–∞–∑, <kbd>‚Üì</kbd> —Ç–æ—Ä–º–æ–∑, <kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> –Ω–∞–∫–ª–æ–Ω, <kbd>R</kbd> —Å–±—Ä–æ—Å, <kbd>P</kbd> –ø–∞—É–∑–∞
</div>

<button class="btn pause-btn" data-act="pause">‚è∏ –ü–∞—É–∑–∞</button>

<div class="mobile-pad">
    <div class="mobile-group">
        <button class="btn big" data-act="tiltL">‚ü≤</button>
        <button class="btn big" data-act="tiltR">‚ü≥</button>
    </div>
    <div class="mobile-group">
        <button class="btn big" data-act="brake">üß±</button>
        <button class="btn big" data-act="gas">üöÄ</button>
    </div>
</div>

<script>
    // === –£—Ç–∏–ª–∏—Ç—ã ===============================================================
    const rand = (seed => () => (seed = (seed * 9301 + 49297) % 233280) / 233280)(123456);
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const lerp  = (a, b, t) => a + (b - a) * t;

    // === –ö–∞–Ω–≤–∞—Å –∏ –º–∞—Å—à—Ç–∞–± ======================================================
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    function resize(){
      canvas.width  = Math.floor(innerWidth * DPR);
      canvas.height = Math.floor(innerHeight * DPR);
      canvas.style.width = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
    }
    addEventListener('resize', resize, {passive:true});
    resize();

    // === –¢–µ—Ä—Ä–µ–π–Ω: –≥–ª–∞–¥–∫–∏–µ –≤–æ–ª–Ω—ã –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è y(x) ==============================
    // y(x) = base + Œ£ A * sin(x / L + œÜ)
    const waves = [
      {A: 80, L: 520, P: rand()*Math.PI*2},
      {A: 35, L: 220, P: rand()*Math.PI*2},
      {A: 18, L: 110, P: rand()*Math.PI*2},
    ];
    const BASE = 380; // –±–∞–∑–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞
    const GROUND_SCALE_X = 1; // 1 –µ–¥. = 1px –ø–æ X –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã

    function terrainY(x){
      let y = BASE;
      for(const w of waves){ y += w.A * Math.sin((x/ w.L) + w.P); }
      return y;
    }
    function terrainSlope(x){
      // –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è y'(x)
      let s = 0;
      for(const w of waves){ s += (w.A / w.L) * Math.cos((x / w.L) + w.P); }
      return s; // dy/dx
    }

    // === –§–∏–∑–∏–∫–∞ –Ω–∞ –í–µ—Ä–ª–µ (Verlet) =============================================
    class Point{
      constructor(x, y){
        this.x = x; this.y = y; this.px = x; this.py = y; this.ax = 0; this.ay = 0;
        this.mass = 1;
      }
      addForce(fx, fy){ this.ax += fx / this.mass; this.ay += fy / this.mass; }
      integrate(dt, damping){
        const nx = this.x + (this.x - this.px) * damping + this.ax * dt * dt;
        const ny = this.y + (this.y - this.py) * damping + this.ay * dt * dt;
        this.px = this.x; this.py = this.y;
        this.x = nx; this.y = ny;
        this.ax = 0; this.ay = 0;
      }
      vel(){ return {vx: this.x - this.px, vy: this.y - this.py}; }
      translate(dx, dy){ this.x += dx; this.y += dy; }
    }

    class Stick{ // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
      constructor(a, b, len, stiff=1){ this.a=a; this.b=b; this.len=len; this.stiff=stiff; }
      solve(){
        let dx = this.b.x - this.a.x, dy = this.b.y - this.a.y;
        let dist = Math.hypot(dx, dy) || 1e-6;
        const diff = (dist - this.len) / dist;
        const px = dx * 0.5 * this.stiff * diff;
        const py = dy * 0.5 * this.stiff * diff;
        this.a.x += px; this.a.y += py;
        this.b.x -= px; this.b.y -= py;
      }
    }

    // === –ú–∞—à–∏–Ω–∫–∞ ==============================================================
    const car = {
      wheelR: 18,
      wheelL: new Point(0,0),
      wheelRr: new Point(0,0),
      body: new Point(0,0),
      sticks: [],
      reset(x){
        const y = terrainY(x) - 60;
        this.wheelL.x = x - 60; this.wheelL.y = y;
        this.wheelRr.x = x + 60; this.wheelRr.y = y;
        this.wheelL.px = this.wheelL.x; this.wheelL.py = this.wheelL.y;
        this.wheelRr.px = this.wheelRr.x; this.wheelRr.py = this.wheelRr.y;
        this.body.x = x; this.body.y = y - 38;
        this.body.px = this.body.x; this.body.py = this.body.y;
        this.sticks = [
          new Stick(this.wheelL, this.wheelRr, 120, 0.98), // –±–∞–∑–∞ –∫–æ–ª—ë—Å
          new Stick(this.wheelL, this.body,   70,  0.98), // –ø–æ–¥–≤–µ—Å–∫–∞
          new Stick(this.wheelRr, this.body,  70,  0.98),
        ];
      }
    };

    // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
    car.reset(120);

    // === –í–≤–æ–¥ (–∫–ª–∞–≤–∏—à–∏ + –∫–Ω–æ–ø–∫–∏) ==============================================
    const input = { gas:false, brake:false, tiltL:false, tiltR:false, pause:false };

    const Key = { ArrowUp:'gas', ArrowDown:'brake', ArrowLeft:'tiltL', ArrowRight:'tiltR', KeyR:'reset', KeyP:'pause', Space:'pause' };
    addEventListener('keydown', (e)=>{
      if(Key[e.code]){ e.preventDefault(); }
      switch(e.code){
        case 'ArrowUp': input.gas = true; break;
        case 'ArrowDown': input.brake = true; break;
        case 'ArrowLeft': input.tiltL = true; break;
        case 'ArrowRight': input.tiltR = true; break;
        case 'KeyR': resetGame(); break;
        case 'KeyP': case 'Space': togglePause(); break;
      }
    });
    addEventListener('keyup', (e)=>{
      switch(e.code){
        case 'ArrowUp': input.gas = false; break;
        case 'ArrowDown': input.brake = false; break;
        case 'ArrowLeft': input.tiltL = false; break;
        case 'ArrowRight': input.tiltR = false; break;
      }
    });

    // –ö–Ω–æ–ø–∫–∏ UI (–≤–∫–ª—é—á–∞—è –º–æ–±–∏–ª—å–Ω—ã–π)
    function bindButtons(){
      const buttons = document.querySelectorAll('[data-act]');
      buttons.forEach(b=>{
        const act = b.getAttribute('data-act');
        const press = (on)=>{
          if(act==='reset') { if(on) resetGame(); return; }
          if(act==='pause') { if(on) togglePause(); return; }
          input[act] = on;
          b.classList.toggle('on', on);
        };
        const onDown = (e)=>{ e.preventDefault(); press(true); };
        const onUp   = (e)=>{ e.preventDefault(); press(false); };
        b.addEventListener('pointerdown', onDown);
        b.addEventListener('pointerup', onUp);
        b.addEventListener('pointerleave', onUp);
        b.addEventListener('pointercancel', onUp);
      });
    }
    bindButtons();

    function resetGame(){ car.reset(car.wheelRr.x); }
    let paused = false; function togglePause(){ paused = !paused; }

    // === –ö–∞–º–µ—Ä–∞ ===============================================================
    const cam = { x: car.body.x, y: car.body.y, zoom: 1 };

    // === –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª =========================================================
    let last = performance.now();
    let acc = 0; const dt = 1/120; // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —à–∞–≥ —Ñ–∏–∑–∏–∫–∏
    const damping = 0.999; // –¥–µ–º–ø—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ –í–µ—Ä–ª–µ
    const gravity = 800;   // px/s^2

    function stepPhysics(){
      const motorAcc = 2200;  // —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π, –∫–æ–≥–¥–∞ –∫–æ–ª–µ—Å–æ –Ω–∞ –∑–µ–º–ª–µ
      const tiltRate = 3.0;   // —Ä–∞–¥/—Å–µ–∫ –¥–ª—è –Ω–∞–∫–ª–æ–Ω–∞ –∫–æ—Ä–ø—É—Å–∞
      const frictionK = 0.96; // —Ç—Ä–µ–Ω–∏–µ —Å–∫–æ–ª—å–∂–µ–Ω–∏—è –ø–æ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π

      // –°–∏–ª—ã —Ç—è–∂–µ—Å—Ç–∏
      for(const p of [car.wheelL, car.wheelRr, car.body]){
        p.addForce(0, gravity * p.mass);
      }

      // –¢–ò–õ–¢: –ø–æ–≤–æ—Ä–æ—Ç —Ç–æ—á–∫–∏ –∫–æ—Ä–ø—É—Å–∞ –≤–æ–∫—Ä—É–≥ —Å–µ—Ä–µ–¥–∏–Ω—ã –º–µ–∂–¥—É –∫–æ–ª—ë—Å–∞–º–∏
      if(input.tiltL || input.tiltR){
        const midx = (car.wheelL.x + car.wheelRr.x) * 0.5;
        const midy = (car.wheelL.y + car.wheelRr.y) * 0.5;
        let vx = car.body.x - midx, vy = car.body.y - midy;
        const ang = (input.tiltR ? 1 : 0) - (input.tiltL ? 1 : 0);
        const a = ang * tiltRate * dt;
        const cos = Math.cos(a), sin = Math.sin(a);
        const nx = vx * cos - vy * sin;
        const ny = vx * sin + vy * cos;
        const dx = nx - vx, dy = ny - vy;
        car.body.translate(dx, dy);
        car.body.px += dx; car.body.py += dy; // —á—Ç–æ–±—ã –Ω–µ –≤–Ω–æ—Å–∏—Ç—å —ç–Ω–µ—Ä–≥–∏–∏
      }

      // –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫–∏
      for(const p of [car.wheelL, car.wheelRr, car.body]){
        p.integrate(dt, damping);
      }

      // –†–µ—à–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–ø–æ–¥–≤–µ—Å–∫–∞ –∏ –±–∞–∑–∞)
      for(let i=0;i<8;i++){
        for(const s of car.sticks) s.solve();
      }

      // –ö–æ–ª–ª–∏–∑–∏–∏ –∫–æ–ª—ë—Å —Å –∑–µ–º–ª—ë–π + –º–æ—Ç–æ—Ä –∏ —Ç—Ä–µ–Ω–∏–µ
      handleWheel(car.wheelL);
      handleWheel(car.wheelRr);

      function handleWheel(w){
        const x = w.x, y = w.y, r = car.wheelR;
        const gy = terrainY(x);
        const slope = terrainSlope(x);
        const tlen = Math.hypot(1, slope) || 1; // –∫–∞—Å–∞—Ç–µ–ª—å–Ω–∞—è
        const tx = 1 / tlen, ty = slope / tlen;
        const nx = -ty, ny = tx; // –Ω–æ—Ä–º–∞–ª—å (–≤–≤–µ—Ä—Ö –∏–∑ –∑–µ–º–ª–∏)

        // –≥–ª—É–±–∏–Ω–∞ –ø—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –ø–æ –Ω–æ—Ä–º–∞–ª–∏ (–∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π)
        const d = (y - gy) * ny; // –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ –Ω–æ—Ä–º–∞–ª—å
        if(d < r){
          // –≤—ã—Ç–∞–ª–∫–∏–≤–∞–µ–º –∫–æ–ª–µ—Å–æ –∏–∑ –∑–µ–º–ª–∏ –≤–¥–æ–ª—å –Ω–æ—Ä–º–∞–ª–∏
          const pen = r - d;
          w.x += nx * pen;
          w.y += ny * pen;

          // —Å–∫–æ—Ä–æ—Å—Ç—å
          const vx = w.x - w.px, vy = w.y - w.py;
          const vn = vx*nx + vy*ny;
          const vtx = vx - vn*nx, vty = vy - vn*ny; // –∫–∞—Å–∞—Ç–µ–ª—å–Ω–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è

          // –∑–∞–ø—Ä–µ—â–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –∑–µ–º–ª—é
          let nvx = vtx + Math.max(0, vn) * nx; // –µ—Å–ª–∏ vn>0 ‚Äî –æ—Ç –∑–µ–º–ª–∏; –µ—Å–ª–∏ <0 ‚Äî –∑–∞–Ω—É–ª—è–µ–º
          let nvy = vty + Math.max(0, vn) * ny;

          // —Ç—Ä–µ–Ω–∏–µ —Å–∫–æ–ª—å–∂–µ–Ω–∏—è
          nvx *= frictionK; nvy *= frictionK;

          // –¢–æ—Ä–º–æ–∑ —É—Å–∏–ª–∏–≤–∞–µ—Ç —Ç—Ä–µ–Ω–∏–µ
          if(input.brake){ nvx *= 0.70; nvy *= 0.70; }

          // –ú–æ—Ç–æ—Ä: –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–≥–æ–Ω –ø–æ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π
          const motor = (input.gas ? 1 : 0) - (input.brake ? 0.2 : 0);
          if(motor !== 0){
            // –∞–∫—Å–µ–ª—è—Ü–∏—è –ø–æ –∫–∞—Å–∞—Ç–µ–ª—å–Ω–æ–π (tx,ty)
            nvx += tx * motorAcc * dt * motor * 0.0015; // –Ω–µ–±–æ–ª—å—à–∞—è –ø—Ä–∏–±–∞–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
            nvy += ty * motorAcc * dt * motor * 0.0015;
          }

          // –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–∑–∏—Ü–∏—é –∏—Å—Ö–æ–¥—è –∏–∑ –Ω–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
          w.px = w.x - nvx; w.py = w.y - nvy;
        }
      }

      // –∫–∞–º–µ—Ä—É –ø–ª–∞–≤–Ω–æ –≤–µ–¥—ë–º –∑–∞ –º–∞—à–∏–Ω–∫–æ–π
      const targetX = (car.wheelL.x + car.wheelRr.x)/2;
      const targetY = (car.wheelL.y + car.wheelRr.y)/2 - 80;
      cam.x = lerp(cam.x, targetX, 0.08);
      cam.y = lerp(cam.y, targetY, 0.08);
    }

    function draw(){
      const w = canvas.width, h = canvas.height;
      ctx.setTransform(DPR,0,0,DPR,0,0); // —Ä–∏—Å—É–µ–º –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∏–∫—Å–µ–ª—è—Ö
      ctx.clearRect(0,0,w/DPR,h/DPR);

      // —Ñ–æ–Ω
      const grd = ctx.createLinearGradient(0,0,0,h/DPR);
      grd.addColorStop(0, '#0b1020');
      grd.addColorStop(1, '#0e1116');
      ctx.fillStyle = grd; ctx.fillRect(0,0,w/DPR,h/DPR);

      ctx.save();
      // –º–∏—Ä–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: —Å–¥–≤–∏–≥ –∫–∞–º–µ—Ä—ã
      ctx.translate((w/DPR)/2 - cam.x, (h/DPR)/2 - cam.y);

      // —Ä–∏—Å—É–µ–º —Ç–µ—Ä—Ä–µ–π–Ω –∫—É—Å–æ—á–Ω–æ
      ctx.lineWidth = 2; ctx.strokeStyle = '#2dd4bf'; ctx.fillStyle = '#0b1325';
      ctx.beginPath();
      const X0 = cam.x - (w/DPR)/2 - 50;
      const X1 = cam.x + (w/DPR)/2 + 50;
      const step = 6;
      ctx.moveTo(X0, terrainY(X0));
      for(let x = X0; x <= X1; x += step){ ctx.lineTo(x, terrainY(x)); }
      ctx.lineTo(X1, h);
      ctx.lineTo(X0, h);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // –º–∞—à–∏–Ω–∫–∞
      drawCar();

      ctx.restore();

      // HUD: —Å–∫–æ—Ä–æ—Å—Ç—å
      const vx = ((car.wheelL.x - car.wheelL.px) + (car.wheelRr.x - car.wheelRr.px)) * 0.5 / dt; // px/s
      const speed = Math.abs(vx);
      document.getElementById('meter').textContent = `—Å–∫–æ—Ä–æ—Å—Ç—å: ${speed.toFixed(0)} px/s`;
    }

    function drawCar(){
      // —Ç–µ–Ω—å
      const cx = (car.wheelL.x + car.wheelRr.x)/2;
      const cy = (car.wheelL.y + car.wheelRr.y)/2 + 24;
      const grad = ctx.createRadialGradient(cx, cy, 10, cx, cy, 140);
      grad.addColorStop(0,'rgba(0,0,0,.3)'); grad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(cx, cy, 120, 0, Math.PI*2); ctx.fill();

      // —Ä—ë–±—Ä–∞ —à–∞—Å—Å–∏
      ctx.lineWidth = 3; ctx.strokeStyle = '#93c5fd';
      ctx.beginPath();
      ctx.moveTo(car.wheelL.x, car.wheelL.y);
      ctx.lineTo(car.wheelRr.x, car.wheelRr.y);
      ctx.lineTo(car.body.x, car.body.y);
      ctx.lineTo(car.wheelL.x, car.wheelL.y);
      ctx.stroke();

      // –∫–æ—Ä–ø—É—Å (–Ω–µ–±–æ–ª—å—à–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫)
      const mx = (car.wheelL.x + car.wheelRr.x)/2;
      const my = (car.wheelL.y + car.wheelRr.y)/2;
      const bx = car.body.x, by = car.body.y;
      const ux = bx - mx, uy = by - my; // –≤–µ–∫—Ç–æ—Ä –≤–≤–µ—Ä—Ö –æ—Ç –±–∞–∑—ã
      const len = Math.hypot(ux, uy) || 1; const nx = -uy/len, ny = ux/len; // –ø–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä –¥–ª—è —à–∏—Ä–∏–Ω—ã –∫—É–∑–æ–≤–∞
      const halfW = 20, halfH = 10;
      const p1x = bx + nx*halfW - ux/len*halfH, p1y = by + ny*halfW - uy/len*halfH;
      const p2x = bx - nx*halfW - ux/len*halfH, p2y = by - ny*halfW - uy/len*halfH;
      const p3x = bx - nx*halfW + ux/len*halfH, p3y = by - ny*halfW + uy/len*halfH;
      const p4x = bx + nx*halfW + ux/len*halfH, p4y = by + ny*halfW + uy/len*halfH;
      ctx.fillStyle = '#38bdf8';
      ctx.beginPath(); ctx.moveTo(p1x,p1y); ctx.lineTo(p2x,p2y); ctx.lineTo(p3x,p3y); ctx.lineTo(p4x,p4y); ctx.closePath(); ctx.fill();

      // –∫–æ–ª—ë—Å–∞
      drawWheel(car.wheelL.x, car.wheelL.y, car.wheelR);
      drawWheel(car.wheelRr.x, car.wheelRr.y, car.wheelR);
    }

    function drawWheel(x,y,r){
      ctx.fillStyle = '#0ea5e9';
      ctx.strokeStyle = '#67e8f9';
      ctx.lineWidth = 2.5;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      // —Å–ø–∏—Ü—ã
      ctx.strokeStyle = 'rgba(255,255,255,.6)';
      ctx.lineWidth = 1.5;
      for(let i=0;i<3;i++){
        const a = i * Math.PI*2/3;
        ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x + Math.cos(a)*r, y + Math.sin(a)*r); ctx.stroke();
      }
    }

    function gameLoop(ts){
      const elapsed = Math.min(0.05, (ts - last)/1000);
      last = ts; if(!paused){ acc += elapsed; }
      const substeps = 4; const step = dt * substeps;
      while(acc >= step){
        for(let i=0;i<substeps;i++) stepPhysics();
        acc -= step;
      }
      draw();
      requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ä–µ—Å–µ—Ç –µ—Å–ª–∏ —É–ª–µ—Ç–µ–ª–∏ –≤–Ω–∏–∑
    setInterval(()=>{
      const avgY = (car.wheelL.y + car.wheelRr.y + car.body.y)/3;
      if(avgY > terrainY(car.wheelL.x)+800){ resetGame(); }
    }, 1500);
</script>
</body>
</html>
